<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>OneDrive File Picker Integration</title>
    <script
      type="text/javascript"
      src="https://js.live.net/v7.2/OneDrive.js"
    ></script>
    <script src="https://alcdn.msauth.net/browser/2.19.0/js/msal-browser.min.js"></script>
  </head>
  <body>
    <button id="launchPicker">Pick Files</button>

    <script type="text/javascript" src="scripts/auth.js"></script>
    <script>
      // Initialize the MSAL application object
      const msalConfig = {
        auth: {
          clientId: "7d4ac4d9-1861-4102-9323-982fc0815db5", // Your client ID
          authority: "https://login.microsoftonline.com/consumers", // Authority
          redirectUri: "https://onedrive-production.up.railway.app", // Redirect URI
        },
      };
      const myMSALObj = new msal.PublicClientApplication(msalConfig);

      async function getToken() {
        try {
          // Attempt to acquire token silently
          const silentResult = await myMSALObj.acquireTokenSilent({
            scopes: ["user.read", "files.readwrite.all"],
          });
          return silentResult.accessToken;
        } catch (error) {
          // If silent token acquisition fails, use popup
          if (error instanceof msal.InteractionRequiredAuthError) {
            try {
              const popupResult = await myMSALObj.acquireTokenPopup({
                scopes: ["user.read", "files.readwrite.all"],
              });
              return popupResult.accessToken;
            } catch (error) {
              console.error(error);
            }
          } else {
            console.error(error);
          }
        }
        return null;
      }

      async function launchOneDrivePicker() {
        const accessToken = await getToken();
        if (!accessToken) {
          console.log("Failed to get access token");
          return;
        }

        const odOptions = {
          clientId: msalConfig.auth.clientId,
          action: "download",
          multiSelect: true,
          advanced: {
            accessToken: accessToken,
            redirectUri: msalConfig.auth.redirectUri,
          },
          success: function (files) {
            console.log("Files picked: ", files);
          },
          cancel: function () {
            console.log("User cancelled.");
          },
          error: function (e) {
            console.log("Error: ", e);
          },
        };

        OneDrive.open(odOptions);
      }

      document
        .getElementById("launchPicker")
        .addEventListener("click", function () {
          launchOneDrivePicker();
        });
    </script>
  </body>
</html>
